name: Auto update rule

on:
  workflow_dispatch:
  schedule:
    - cron: '25 0/3 * * *'
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    # ===== 防止 CI 自触发 =====
    # 允许：
    # - 手动触发
    # - 定时触发
    # - 非 Bot 用户 push 到 master
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'push' && github.actor != 'Gitea Action Bot')

    steps:
      - uses: actions/checkout@v4

      - name: Run start-ci.sh
        run: |
          /bin/bash ./scripts/start-ci.sh

      # 3. 生成并重建 ad 分支
      - name: Build ad branch snapshot
        run: |
          set -e

          git config --local user.email "action@your-gitea-instance.com"
          git config --local user.name "Gitea Action Bot"

          # ===== 只允许进入 ad 分支的文件 =====
          KEEP_FILES=(
            "ad.yaml"
            "ad-easylist.txt"
            "ad-smartdns.conf"
            "ad.list"
            "ad.conf"
          )

          SRC_COMMIT=$(git rev-parse HEAD)

          git checkout --orphan ad
          git rm -rf . >/dev/null 2>&1 || true

          for f in "${KEEP_FILES[@]}"; do
            if git show "$SRC_COMMIT:$f" >/dev/null 2>&1; then
              git checkout "$SRC_COMMIT" -- "$f"
            fi
          done

          find . -type f -name "*.md5" -delete

          git add .
          git commit -m "ad rules snapshot : $(TZ=UTC-8 date "+%Y-%m-%d %H:%M:%S")"

      # 4. 推送 ad 分支
      - name: Push ad branch
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.PERSON_TOKEN }}
          branch: ad

      - name: Delete workflow
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3
