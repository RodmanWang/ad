name: Auto update rule

on:
  workflow_dispatch:
  schedule:
    - cron: '25 0/3 * * *'   # 每3小时25分执行一次
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出 master
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 运行生成脚本（在 master 上生成文件）
      - name: Run start-ci.sh
        run: |
          /bin/bash ./scripts/start-ci.sh

      # 3. 生成 ad 分支（孤立分支，只保留指定文件）
      - name: Build ad branch snapshot
        run: |
          set -e

          git config --local user.email "action@your-gitea-instance.com"
          git config --local user.name "Gitea Action Bot"

          # 文件白名单
          KEEP_FILES=(
            "ad.yaml"
            "ad-easylist.txt"
            "ad-smartdns.conf"
            "ad.list"
            "ad.conf"
          )

          # 当前 master commit
          SRC_COMMIT=$(git rev-parse HEAD)

          # 创建孤立分支
          git checkout --orphan ad

          # 删除所有文件，包括未跟踪和隐藏文件
          git rm -rf . >/dev/null 2>&1 || true
          git clean -fdx >/dev/null 2>&1

          # 从 master 检出存在的白名单文件
          FILES_TO_ADD=()
          for f in "${KEEP_FILES[@]}"; do
            if git show "$SRC_COMMIT:$f" >/dev/null 2>&1; then
              git checkout "$SRC_COMMIT" -- "$f"
              FILES_TO_ADD+=("$f")
            fi
          done

          # 强制删除 md5 文件
          find . -type f -name "*.md5" -delete

          # 只有存在文件才提交
          if [ ${#FILES_TO_ADD[@]} -gt 0 ]; then
            git add .
            git commit -m "ad rules snapshot : $(TZ=UTC-8 date '+%Y-%m-%d %H:%M:%S')"
          else
            echo "No files to commit, skipping commit."
          fi

      # 4. 强制推送 ad 分支（即使没有提交也会保持分支存在）
      - name: Push ad branch
        run: |
          git push -f origin ad || echo "No changes to push"

      # 5. 清理旧的 workflow runs（仅 GitHub 有效）
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 3
